<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Mis Pedidos</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: #FFFFFF;
			padding: 1rem;
			height: 100vh;
			overflow-y: auto;
		}
		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1.5rem;
			padding-bottom: 1rem;
			border-bottom: 1px solid #E5E5E5;
		}
		.title {
			font-size: 1.25rem;
			font-weight: 600;
			color: #000000;
		}
		.close-btn {
			background: rgba(0, 0, 0, 0.05);
			border: none;
			border-radius: 50%;
			width: 2rem;
			height: 2rem;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			font-size: 1.25rem;
			color: #666666;
		}
		.close-btn:active {
			background: rgba(0, 0, 0, 0.1);
		}
		.loading {
			text-align: center;
			padding: 2rem;
			color: #666666;
		}
		.empty {
			text-align: center;
			padding: 3rem 1rem;
			color: #666666;
		}
		.empty-icon {
			font-size: 3rem;
			margin-bottom: 1rem;
		}
		.order-item {
			background: #F8F9FA;
			border-radius: 0.5rem;
			padding: 1rem;
			margin-bottom: 1rem;
			border-left: 4px solid #2B73EE;
			transition: transform 0.2s, box-shadow 0.2s;
		}
		.order-item:active {
			transform: scale(0.98);
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
		}
		.order-header {
			display: flex;
			justify-content: space-between;
			align-items: start;
			margin-bottom: 0.5rem;
		}
		.order-id {
			font-weight: 600;
			color: #000000;
			font-size: 0.9rem;
		}
		.order-status {
			background: #2B73EE;
			color: white;
			padding: 0.25rem 0.75rem;
			border-radius: 1rem;
			font-size: 0.75rem;
			font-weight: 500;
		}
		.order-info {
			font-size: 0.875rem;
			color: #666666;
			margin-top: 0.5rem;
		}
		.order-info strong {
			color: #000000;
		}
		.error {
			background: #FFF3CD;
			color: #856404;
			padding: 1rem;
			border-radius: 0.5rem;
			margin: 1rem 0;
			text-align: center;
		}
	</style>
</head>
<body>
	<div class="header">
		<div>
			<h1 class="title">Mis Pedidos Activos</h1>
			<span id="orders-count" style="font-size: 0.875rem; color: #666666; margin-top: 0.25rem; display: block;">Cargando...</span>
		</div>
		<button class="close-btn" onclick="window.Android.closePanel()">‚úï</button>
	</div>
	
	<div id="content">
		<div class="loading">Cargando pedidos...</div>
	</div>

	<script>
		// Obtener datos del driver desde localStorage (si est√° disponible)
		async function getDriverData() {
			try {
				// Intentar obtener desde Android
				if (window.Android && window.Android.getDriverData) {
					const data = window.Android.getDriverData();
					console.log('Driver data raw:', data);
					if (data && data !== 'null' && data !== '') {
						try {
							const parsed = JSON.parse(data);
							console.log('Driver data parsed:', parsed);
							return parsed;
						} catch (parseError) {
							console.error('Error parseando driver data:', parseError);
							return null;
						}
					}
				}
				console.warn('No se pudo obtener driver data desde Android');
				return null;
			} catch (e) {
				console.error('Error obteniendo datos del driver:', e);
				return null;
			}
		}

		// Cargar pedidos desde Supabase
		async function loadOrders() {
			const content = document.getElementById('content');
			const driverData = await getDriverData();
			
			if (!driverData || !driverData.id) {
				console.error('Driver data inv√°lido:', driverData);
				content.innerHTML = `
					<div class="error">
						No se pudo obtener la informaci√≥n del repartidor.
						<br><br>
						<p style="font-size: 0.875rem; margin-top: 0.5rem;">Por favor, inicia sesi√≥n en la aplicaci√≥n primero.</p>
						<button onclick="window.Android.openApp()" style="
							background: #2B73EE;
							color: white;
							border: none;
							padding: 0.75rem 1.5rem;
							border-radius: 0.5rem;
							margin-top: 1rem;
							cursor: pointer;
							font-size: 1rem;
						">Abrir App</button>
					</div>
				`;
				return;
			}

			try {
				// Obtener configuraci√≥n de Supabase desde Android
				let supabaseUrl = '';
				let supabaseKey = '';
				
				if (window.Android && window.Android.getSupabaseConfig) {
					const config = window.Android.getSupabaseConfig();
					console.log('Supabase config raw:', config);
					if (config && config !== 'null' && config !== '') {
						try {
							const parsed = JSON.parse(config);
							supabaseUrl = parsed.url || '';
							supabaseKey = parsed.key || '';
							console.log('Supabase URL:', supabaseUrl ? 'OK' : 'MISSING');
							console.log('Supabase Key:', supabaseKey ? 'OK' : 'MISSING');
						} catch (parseError) {
							console.error('Error parseando Supabase config:', parseError);
						}
					}
				}

				if (!supabaseUrl || !supabaseKey) {
					console.error('Configuraci√≥n de Supabase incompleta:', { url: !!supabaseUrl, key: !!supabaseKey });
					throw new Error('Configuraci√≥n de Supabase no disponible. Por favor, abre la app para configurar.');
				}

				const driverId = driverData.id;
				const companyId = driverData.companyId || driverData.company_id;

				// Construir query para obtener pedidos asignados al driver que no est√©n entregados
				let queryUrl = `${supabaseUrl}/rest/v1/orders?select=*,clients(name,phone,address),locals(name,address)&driver_id=eq.${driverId}&status=neq.Entregado&order=created_at.desc`;
				
				// Si tiene company_id, tambi√©n filtrar por empresa
				if (companyId) {
					queryUrl += `&company_id=eq.${companyId}`;
				}

				const response = await fetch(queryUrl, {
					headers: {
						'apikey': supabaseKey,
						'Authorization': `Bearer ${supabaseKey}`,
						'Content-Type': 'application/json',
						'Prefer': 'return=representation'
					}
				});

				if (!response.ok) {
					const errorText = await response.text();
					console.error('Error response:', errorText);
					throw new Error(`Error ${response.status}: ${errorText}`);
				}

				const orders = await response.json();
				
				// Filtrar solo pedidos que realmente pertenecen al driver y no est√°n entregados
				const activeOrders = orders.filter(order => 
					order.driver_id === driverId && 
					order.status !== 'Entregado'
				);

				// Actualizar contador
				const countElement = document.getElementById('orders-count');
				if (countElement) {
					if (activeOrders.length === 0) {
						countElement.textContent = '0 pedidos';
					} else {
						countElement.textContent = `${activeOrders.length} ${activeOrders.length === 1 ? 'pedido' : 'pedidos'}`;
					}
				}

				if (activeOrders.length === 0) {
					content.innerHTML = `
						<div class="empty">
							<div class="empty-icon">üì¶</div>
							<p>No tienes pedidos activos</p>
						</div>
					`;
					return;
				}

				// Mostrar pedidos
				content.innerHTML = activeOrders.map(order => {
					const statusColors = {
						'Asignado': '#2B73EE',
						'En camino al retiro': '#FFA500',
						'Producto retirado': '#9B59B6',
						'Pendiente': '#95A5A6'
					};
					const statusColor = statusColors[order.status] || '#95A5A6';
					
					// Formatear fecha
					const createdAt = order.created_at ? new Date(order.created_at).toLocaleString('es-CL', {
						day: '2-digit',
						month: '2-digit',
						year: 'numeric',
						hour: '2-digit',
						minute: '2-digit'
					}) : 'N/A';
					
					return `
						<div class="order-item" onclick="window.Android.openApp()" style="cursor: pointer;">
							<div class="order-header">
								<div class="order-id">Pedido #${order.id}</div>
								<div class="order-status" style="background: ${statusColor}">
									${order.status}
								</div>
							</div>
							<div class="order-info">
								<strong>Cliente:</strong> ${(order.clients?.name || 'N/A').substring(0, 30)}${order.clients?.name && order.clients.name.length > 30 ? '...' : ''}<br>
								<strong>Tel√©fono:</strong> ${order.clients?.phone || 'N/A'}<br>
								<strong>Retiro:</strong> ${(order.locals?.name || order.pickup_address || 'N/A').substring(0, 40)}${(order.locals?.name || order.pickup_address || '').length > 40 ? '...' : ''}<br>
								<strong>Entrega:</strong> ${(order.delivery_address || 'N/A').substring(0, 40)}${(order.delivery_address || '').length > 40 ? '...' : ''}<br>
								<strong>Precio:</strong> $${parseFloat(order.suggested_price || 0).toLocaleString('es-CL')}<br>
								<strong>Creado:</strong> ${createdAt}
							</div>
						</div>
					`;
				}).join('');

			} catch (error) {
				console.error('Error cargando pedidos:', error);
				content.innerHTML = `
					<div class="error">
						Error al cargar los pedidos: ${error.message}
						<br><br>
						<button onclick="window.Android.openApp()" style="
							background: #2B73EE;
							color: white;
							border: none;
							padding: 0.75rem 1.5rem;
							border-radius: 0.5rem;
							margin-top: 1rem;
							cursor: pointer;
							font-size: 1rem;
						">Abrir App</button>
					</div>
				`;
			}
		}

		// Cargar pedidos al iniciar
		loadOrders();

		// Recargar cada 30 segundos
		setInterval(loadOrders, 30000);
	</script>
</body>
</html>

